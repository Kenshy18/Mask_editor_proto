# 実装タスクリスト

## 開発方針
- **段階的実装**: MVPから始め、段階的に機能を追加
- **モジュール化**: 各コンポーネントを独立して開発・テスト可能に
- **Python優先**: 初期実装はPythonで行い、必要に応じてC++化
- **品質重視**: 各段階でテストを実施し、要件を満たすことを確認
- **Port/Adapter構造**: Hexagonalアーキテクチャを採用し、コンポーネントの置換を容易に
- **DTO/VO統一**: 外部ライブラリ依存を境界内に封じ込め、純粋なデータ型で通信
- **DI活用**: 依存性注入により、実装の切り替えを設定ベースで実現

## フェーズ1: 基盤構築（MVP）

### 1.1 プロジェクト基盤 ✅
- [x] プロジェクト構造の作成
  - [x] ディレクトリ構造の定義
  - [x] requirements.txtの作成
  - [x] 基本的な設定ファイル（.gitignore, pyproject.toml等）
  - [x] CI/CD基盤の準備（GitHub Actions等）

### 1.2 データモデル定義 ✅
- [x] コアデータクラスの実装
  - [x] Frame（pts, dts, timecode, colorspace等を含む）
  - [x] Mask（ID、クラス、信頼度等のメタデータ付き）
  - [x] BoundingBox（x, y, w, h, ID, score）
  - [x] Project（タイムライン、編集履歴、設定）
  - [x] AlertTag（4段階レベル、理由、範囲）

### 1.3 Media I/O基盤 ✅
- [x] 動画読み込み機能（FR-1, FR-39）
  - [x] FFmpegラッパーの実装（PyAV or ffmpeg-python）
  - [x] 主要コーデック対応（H.264/H.265, ProRes, DNxHR等）
  - [x] メタデータ保持（色空間、ビット深度、サブサンプリング）
  - [x] タイムコード/PTS/DTS保持（FR-34）
- [x] 動画書き出し機能（FR-1, FR-40）
  - [x] ストリームコピー優先実装（FR-28）
  - [x] 音声同期保持（±20ms以内）（FR-29）
- [x] マスクデータ読み込み（IN-2）
  - [x] NPY形式対応
  - [x] PNG形式対応
  - [x] 1bit/8bit両対応
- [x] JSON読み込み（IN-3, IN-4）
  - [x] マスク属性情報パーサー
  - [x] バウンディングボックスパーサー

### 1.4 基本UI構造 ✅
- [x] メインウィンドウ実装（PyQt6）
  - [x] 基本レイアウト（メニュー、ツールバー、ステータスバー）
  - [x] 日本語フォント対応（NFR-16）
- [x] ビデオプレビューウィジェット
  - [x] OpenCVベースの表示
  - [x] 基本的な再生/停止/シーク

## フェーズ2: コア機能実装

**前提条件**: フェーズ1.5の基本的なPort/Adapter構造が実装されていること。
新規実装はすべてPort/Adapterパターンに従い、DIコンテナを活用。

### 2.1 タイムライン実装（FR-4） ✅
- [x] タイムラインウィジェット
  - [x] フレーム/秒単位でのズーム機能
  - [x] スクラブ機能（ドラッグでプレビュー同期）
  - [x] フレーム番号/タイムコード表示
- [x] 状態可視化（FR-5）
  - [x] 未処理/未確認の色分け表示
  - [x] アラート表示機能（FR-6）

### 2.2 マスク表示・編集基盤 ✅
- [x] マスクオーバーレイ表示
  - [x] 透明度調整可能なオーバーレイ
  - [x] ID別の色分け表示
  - [x] ON/OFF切り替え（FR-8）
- [x] 基本的なマスク編集（FR-10）
  - [x] モルフォロジー操作UI（膨張/収縮）
  - [x] オープン/クローズ操作
  - [x] プレビュー機能

### 2.3 プロジェクト管理（FR-2）✅
- [x] プロジェクトファイル（.mosaicproj）の定義
  - [x] JSON/ZIPフォーマット設計
  - [x] バージョン管理スキーマ
- [x] 保存/読み込み機能
  - [x] タイムライン状態の保存
  - [x] 編集履歴の保存
  - [x] 設定の保存
- [x] オートセーブ機能（FR-3, NFR-7）
  - [x] 定期保存（デフォルト1分間隔）
  - [x] クラッシュリカバリ機能

### 2.4 エフェクトエンジン基盤（FR-15）✅
- [x] エフェクトインターフェース定義
  - [x] IEffectプロトコル
  - [x] パラメータ管理システム
- [x] 基本エフェクト実装
  - [x] モザイクエフェクト
  - [x] ブラーエフェクト
  - [x] ピクセレートエフェクト
- [x] プレビューシステム
  - [x] 低解像度プレビュー（NFR-1: 50ms/frame以下）
  - [x] リアルタイムパラメータ調整

## フェーズ3: 高度な編集機能

### 3.1 ブラシツール実装（FR-11） ✅
- [x] ブラシエンジン
  - [x] 新規ID追加モード
  - [x] 既存ID加筆モード
  - [x] ブラシサイズ/硬さ調整
- [x] 描画最適化
  - [x] スムーズな描画
  - [x] Undo/Redo対応

### 3.2 トラッキング機能（FR-12）
- [ ] フレーム間補間
  - [ ] 線形補間
  - [ ] オプティカルフローベース補間
- [ ] 補間パラメータUI
  - [ ] 補間方法選択
  - [ ] 品質設定

### 3.3 ID管理機能 ✅
- [x] マスク削除機能（FR-13）
  - [x] ID指定削除
  - [x] 範囲指定削除
  - [x] 一括削除
- [x] 閾値調整UI（FR-14）
  - [x] 検出閾値スライダー
  - [x] IDマージ閾値スライダー
  - [x] リアルタイムプレビュー

### 3.4 一括適用機能（FR-17）
- [ ] スコープ選択UI
  - [ ] フレーム範囲選択
  - [ ] ID選択
  - [ ] シーン選択
  - [ ] 全体選択
- [ ] 一括操作エンジン
  - [ ] バッチ処理最適化
  - [ ] プログレス表示

## フェーズ4: アラート・品質管理

### 4.1 アラートシステム（FR-19, FR-20）
- [ ] AI出力評価エンジン
  - [ ] 4段階自動分類アルゴリズム
  - [ ] 信頼度ベースのグルーピング
- [ ] 危険物検出
  - [ ] 水面検出アルゴリズム
  - [ ] 鏡/反射面検出
  - [ ] カスタムルール定義
- [ ] アラートUI
  - [ ] タイムライン上のアラート表示
  - [ ] アラート一覧パネル
  - [ ] フィルタリング機能

### 4.2 品質検証システム
- [ ] QC/Validationサービス（NFR-19〜NFR-23）
  - [ ] 色差計算（ΔE00）
  - [ ] PTS誤差チェック
  - [ ] 音声ハッシュ比較
  - [ ] フィールドオーダー確認
- [ ] 品質レポート生成
  - [ ] 自動検証スクリプト
  - [ ] レポート出力（JSON/HTML）

### 4.3 学習データ収集（FR-22〜FR-25）
- [ ] サンプリング機能
  - [ ] ネガティブサンプル（削除マスク）収集
  - [ ] ポジティブサンプル（追加マスク）収集
- [ ] 統計レポート
  - [ ] 工数分析
  - [ ] 修正内容集計
  - [ ] 漏れ率計算
- [ ] エクスポート機能
  - [ ] COCO形式出力
  - [ ] YOLO形式出力

## フェーズ5: パフォーマンス最適化

### 5.1 マルチビュー実装（FR-9）
- [ ] 3ペイン表示
  - [ ] 元動画ビュー
  - [ ] マスクオーバーレイビュー
  - [ ] 処理結果ビュー
- [ ] 同期再生機能
  - [ ] フレーム同期
  - [ ] ズーム同期

### 5.2 高度な再生機能（FR-7）
- [ ] 可変速再生
  - [ ] スロー再生
  - [ ] 高速再生
  - [ ] 逆再生
- [ ] 再生モード
  - [ ] 確認用モード（高品質）
  - [ ] 閲覧用モード（高速）

### 5.3 キーフレーム機能（FR-16）
- [ ] キーフレームエディタ
  - [ ] パラメータ曲線編集
  - [ ] 補間方法選択
- [ ] アニメーション機能
  - [ ] エフェクト強度の時間変化
  - [ ] プレビュー機能

## フェーズ6: 最終仕上げ

### 6.1 非破壊レンダリング（FR-26）
- [ ] レンダリングパイプライン
  - [ ] 低解像度プレビュー生成
  - [ ] 高解像度最終出力
  - [ ] バッチレンダリング
- [ ] 出力設定UI
  - [ ] コーデック選択
  - [ ] 品質設定
  - [ ] メタデータ設定

### 6.2 プラグインシステム（FR-27）
- [ ] プラグインAPI定義
  - [ ] Python API
  - [ ] エフェクトプラグイン
  - [ ] 入出力プラグイン
- [ ] プラグインマネージャー
  - [ ] プラグイン読み込み
  - [ ] バージョン管理
  - [ ] 設定UI

### 6.3 国際化対応
- [ ] i18nフレームワーク導入
  - [ ] 翻訳ファイル管理
  - [ ] 動的言語切り替え
- [ ] 多言語対応
  - [ ] 英語
  - [ ] 中国語
  - [ ] その他言語の拡張性

## テスト計画

### ユニットテスト
- [ ] 各モジュールのテストコード作成
- [ ] カバレッジ80%以上達成（NFR-9）
- [ ] CI/CDでの自動実行

### 統合テスト
- [ ] エンドツーエンドテスト
- [ ] 各種フォーマットでの動作確認
- [ ] パフォーマンステスト

### 受け入れテスト
- [ ] 要件定義書の受入れ基準（セクション7）に基づくテスト
- [ ] 品質基準の確認
- [ ] ユーザビリティテスト

## 開発環境・ツール

### 必須ツール
- Python 3.12以上
- PyQt6 >= 6.5.0
- OpenCV >= 4.8.0
- NumPy >= 1.26.0
- FFmpeg（システムインストール）

### 開発ツール
- pytest（テスト）
- black（コードフォーマット）
- mypy（型チェック）
- ruff（リンター）

## 進捗管理

各タスクの進捗は以下の状態で管理：
- [ ] 未着手
- [x] 完了
- [~] 進行中
- [!] ブロック/課題あり


## C++実装優先順位

### 優先度1: パフォーマンスクリティカル
1. **Media I/O Service**
   - FFmpegラッパー（ストリームコピー処理）
   - 動画デコード/エンコード処理
   - メタデータ抽出

2. **形態学処理エンジン**
   - 大規模マスクの膨張/収縮
   - オープン/クローズ操作
   - SIMD最適化による高速化

### 優先度2: 計算集約的処理

3. **Effect/Render Engine**
   - モザイク、ブラー処理
   - リアルタイムプレビュー生成
   - CUDA/OpenCL活用

### 優先度3: メモリ効率改善
4. **大規模データ処理**
   - マスクデータの圧縮/展開
   - フレームバッファ管理
   - メモリプール実装

### 実装方針
- Port/Adapterパターンにより、Python/C++実装を透過的に切り替え
- pybind11による完全互換インターフェース
- 設定ファイルでの実装選択（backend: "python" | "cpp"）
- 段階的移行による安定性確保
