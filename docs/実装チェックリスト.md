# 実装チェックリスト

## アーキテクチャ設計チェックリスト（Hexagonal Architecture）

### Port/Adapter構造

#### ディレクトリ構造
- [ ] `src/domain/` ディレクトリが作成されているか
- [ ] `src/domain/dto/` にDTOクラスが配置されているか
- [ ] `src/domain/ports/primary/` に入力ポートが定義されているか
- [ ] `src/domain/ports/secondary/` に出力ポートが定義されているか
- [ ] `src/adapters/primary/` にUI等のアダプターが配置されているか
- [ ] `src/adapters/secondary/` に外部リソースアダプターが配置されているか
- [ ] `src/infrastructure/` にDIコンテナ等が配置されているか

#### Port定義
- [ ] すべてのPortがProtocolとして定義されているか
- [ ] Portに外部ライブラリ固有の型が含まれていないか
- [ ] PortのメソッドシグネチャがDTOのみを使用しているか
- [ ] Primary PortとSecondary Portが明確に分離されているか

#### DTO/VO実装
- [ ] すべてのDTOが`@dataclass(frozen=True)`で不変になっているか
- [ ] DTOに外部ライブラリの型（PyAV、QPixmap等）が含まれていないか
- [ ] FrameDTOが常にRGB24形式で統一されているか
- [ ] MaskDTOが常に0-255のuint8で統一されているか
- [ ] DTOに適切な検証ロジック（__post_init__）が実装されているか

#### Adapter実装
- [ ] 各AdapterがPortを正しく実装しているか
- [ ] Adapter内で外部ライブラリ型→DTO変換が行われているか
- [ ] DTO→外部ライブラリ型変換が境界内に封じ込められているか
- [ ] エラーハンドリングが適切に実装されているか

### DIコンテナ

#### コンテナ実装
- [ ] DIContainerクラスが実装されているか
- [ ] register()メソッドで型安全な登録ができるか
- [ ] resolve()メソッドで型安全な解決ができるか
- [ ] シングルトン/非シングルトンの管理が正しく動作するか
- [ ] 設定値の管理機能（get_config）が実装されているか

#### 設定ベース切り替え
- [ ] 設定ファイル（YAML/JSON）が用意されているか
- [ ] container_config.pyで設定に基づく登録が行われているか
- [ ] backend設定の変更のみで実装が切り替わるか
- [ ] 環境変数での上書きが可能か

### C++統合

#### pybind11実装
- [ ] C++クラスがPythonのPortインターフェースを満たしているか
- [ ] 引数と戻り値がDTOの辞書形式で統一されているか
- [ ] numpy配列の変換が効率的に実装されているか
- [ ] GIL（Global Interpreter Lock）の適切な解放が行われているか
- [ ] メモリリークがないか

#### ビルド環境
- [ ] CMakeLists.txtが正しく設定されているか
- [ ] setup.pyでC++拡張がビルドできるか
- [ ] 必要なC++ライブラリ（OpenCV、FFmpeg等）がリンクされているか
- [ ] CI/CDでC++ビルドが自動化されているか

### 段階的リファクタリング

#### 移行準備
- [ ] 既存コードの依存関係図が作成されているか
- [ ] 移行順序（優先度）が決定されているか
- [ ] 各コンポーネントの移行計画が文書化されているか
- [ ] ロールバック手順が準備されているか

#### 移行実施
- [ ] 既存テストがすべてパスする状態を維持しているか
- [ ] 新旧実装の切り替えが設定のみで可能か
- [ ] パフォーマンス比較（A/Bテスト）が実施されているか
- [ ] 移行の進捗が追跡可能か

---

## フェーズ1: 基盤構築チェックリスト

### 1.1 データモデル実装確認

#### Frame クラス
- [ ] pts (int64) が正しく保持されているか
- [ ] dts (int64 | None) が正しく保持されているか
- [ ] timecode (str) がDF/NDF両方に対応しているか
- [ ] colorspace (str) がBT.709/BT.2020等を正しく識別できるか
- [ ] bit_depth (int) が8/10/12bitを正しく保持できるか
- [ ] subsampling (str) が4:2:0/4:2:2/4:4:4を正しく保持できるか
- [ ] numpy配列でフレームデータが効率的に保持されているか
- [ ] メモリ効率を考慮したデータ構造になっているか

#### Mask クラス
- [ ] ID (int) による個体識別が可能か
- [ ] クラス (str) が正しく保持されているか
- [ ] 信頼度 (float) が0.0-1.0の範囲で保持されているか
- [ ] フレームインデックスとの紐付けが正しいか
- [ ] 1bit/8bit両方のマスク形式に対応しているか
- [ ] NPY/PNG両形式の読み書きが可能か

#### BoundingBox クラス
- [ ] x, y, w, h形式で座標が保持されているか
- [ ] (x1,y1,x2,y2)形式への変換機能があるか
- [ ] ID、スコアが正しく保持されているか
- [ ] JSON形式でのシリアライズ/デシリアライズが可能か

### 1.2 Media I/O実装確認

#### 動画読み込み（FR-1, FR-39）
- [ ] H.264/AVCのデコードが可能か
- [ ] H.265/HEVCのデコードが可能か
- [ ] ProResのデコードが可能か
- [ ] DNxHRのデコードが可能か
- [ ] その他主要コーデック（AV1, VP9等）に対応しているか
- [ ] MP4コンテナを正しく読み込めるか
- [ ] MOVコンテナを正しく読み込めるか
- [ ] MKVコンテナを正しく読み込めるか
- [ ] タイムコードが正しく抽出されるか（FR-34）
- [ ] PTS/DTSが64bit精度で保持されるか
- [ ] 色空間情報が正しく抽出されるか（FR-31）
- [ ] HDRメタデータが保持されるか（FR-33）
- [ ] VFR動画を正しく認識できるか（FR-35）
- [ ] インターレース情報（TFF/BFF）を検出できるか（FR-37）

#### 動画書き出し（FR-1, FR-40）
- [ ] ストリームコピーがデフォルトで有効か（FR-28）
- [ ] 音声ストリームコピーが正しく動作するか
- [ ] 音声同期誤差が±20ms以内か（FR-29）
- [ ] メタデータ（言語タグ等）が保持されるか（FR-30）
- [ ] 色空間変換なしでピクセル値が保持されるか（FR-32）
- [ ] タイムコードが正しく書き出されるか（FR-36）
- [ ] VFR/CFRの選択が可能か（FR-35）
- [ ] フィールドオーダーが保持されるか（FR-38）

### 1.3 基本UI実装確認

#### メインウィンドウ
- [ ] PyQt6で実装されているか
- [ ] 日本語フォントが正しく表示されるか（NFR-16）
- [ ] メニューバーが機能しているか
- [ ] ツールバーがカスタマイズ可能か
- [ ] ステータスバーに適切な情報が表示されるか
- [ ] ウィンドウのリサイズが正しく動作するか
- [ ] 設定の保存/復元が可能か

#### ビデオプレビュー
- [ ] 動画が正しく表示されるか
- [ ] 再生/停止が正しく動作するか
- [ ] シーク操作がスムーズか
- [ ] フレームレートが維持されるか
- [ ] メモリリークがないか

---

## フェーズ2: コア機能チェックリスト

### 2.1 タイムライン実装確認（FR-4） ✅

#### 基本機能
- [x] フレーム単位でのズームが可能か
- [x] 秒単位でのズームが可能か
- [x] スクラブ時にプレビューが同期するか
- [x] スクラブ操作がスムーズか（遅延なし）
- [x] タイムコード表示が正確か
- [x] フレーム番号表示が正確か

#### 状態可視化（FR-5, FR-6）
- [x] 未処理セグメントが識別可能か
- [x] 未確認セグメントが識別可能か
- [x] 色分けが直感的か
- [x] アラートがタイムライン上に表示されるか
- [x] アラートレベル（4段階）が識別可能か

### 2.2 マスク表示・編集確認 ✅

#### オーバーレイ表示
- [x] マスクの透明度調整が可能か
- [x] ID別の色分けが機能しているか
- [x] 表示/非表示の切り替えが即座に反映されるか（FR-8）
- [x] 複数マスクの重なりが正しく表示されるか
- [x] パフォーマンスが許容範囲内か

#### モルフォロジー操作（FR-10）
- [x] 膨張操作が正しく動作するか
- [x] 収縮操作が正しく動作するか
- [x] オープン操作が正しく動作するか
- [x] クローズ操作が正しく動作するか
- [x] カーネルサイズの調整が可能か
- [x] プレビューがリアルタイムで更新されるか
- [x] Undo/Redoが正しく動作するか

### 2.3 プロジェクト管理確認（FR-2, FR-3）✅

#### ファイル形式
- [x] .mosaicprojファイルが正しく作成されるか
- [x] JSON形式で内容が保存されるか
- [x] 必要に応じてZIP圧縮されるか
- [x] バージョン情報が含まれているか
- [x] 後方互換性が考慮されているか

#### 保存/読み込み
- [x] タイムライン状態が完全に復元されるか
- [x] 編集履歴が保持されるか
- [x] 各種設定が正しく保存/復元されるか
- [x] 大規模プロジェクトでも動作するか

#### オートセーブ（NFR-7）
- [x] デフォルト1分間隔で自動保存されるか
- [x] 間隔設定が変更可能か
- [x] オートセーブ中も操作が継続可能か
- [x] クラッシュ後にリカバリが可能か
- [x] リカバリ時のデータ整合性が保たれるか

### 2.4 エフェクトエンジン確認（FR-15）

#### 基本エフェクト
- [ ] モザイクのブロックサイズが調整可能か
- [ ] ブラーの半径が調整可能か
- [ ] ピクセレートの粒度が調整可能か
- [ ] エフェクトの強度が調整可能か
- [ ] エフェクトの組み合わせが可能か

#### パフォーマンス（NFR-1）
- [ ] 1080p@30fpsで50ms/frame以下か
- [ ] プレビューがリアルタイムで更新されるか
- [ ] GPUアクセラレーションが有効か（NFR-2）
- [ ] メモリ使用量が適切か

---

## フェーズ3: 高度な編集機能チェックリスト

### 3.1 ブラシツール確認（FR-11）

#### 基本機能
- [ ] 新規ID追加モードが機能するか
- [ ] 既存ID加筆モードが機能するか
- [ ] モード切り替えが直感的か
- [ ] ブラシサイズの調整が可能か
- [ ] ブラシの硬さ調整が可能か
- [ ] 筆圧対応（タブレット使用時）

#### 描画品質
- [ ] 描画がスムーズか（遅延なし）
- [ ] エッジが滑らかか
- [ ] Undo/Redo（100ステップ以上）が機能するか（NFR-12）
- [ ] 大きなマスクでもパフォーマンスが維持されるか

### 3.2 トラッキング機能確認（FR-12）

#### 補間機能
- [ ] 線形補間が正しく動作するか
- [ ] オプティカルフロー補間が正しく動作するか
- [ ] 補間品質の調整が可能か
- [ ] キーフレームの設定が可能か
- [ ] 補間結果のプレビューが可能か

#### 精度確認
- [ ] オブジェクトの動きを正確に追跡できるか
- [ ] オクルージョン（隠れ）に対応できるか
- [ ] 急激な動きにも対応できるか

### 3.3 ID管理機能確認

#### マスク削除（FR-13）
- [ ] 特定IDの削除が可能か
- [ ] フレーム範囲指定での削除が可能か
- [ ] 一括削除が可能か
- [ ] 削除前の確認ダイアログが表示されるか
- [ ] Undoで復元可能か

#### 閾値調整（FR-14, FR-18）
- [ ] 検出閾値のスライダーが機能するか
- [ ] IDマージ閾値のスライダーが機能するか
- [ ] 閾値変更がリアルタイムで反映されるか
- [ ] ID細分化/集約が正しく動作するか
- [ ] 適切なデフォルト値が設定されているか

### 3.4 一括適用確認（FR-17）

#### スコープ選択
- [ ] フレーム範囲の選択UIが直感的か
- [ ] ID選択UIが使いやすいか
- [ ] シーン選択が可能か
- [ ] 全体選択がワンクリックで可能か
- [ ] 選択範囲のプレビューが表示されるか

#### バッチ処理
- [ ] 大量フレームでも安定動作するか
- [ ] プログレスバーが正確か
- [ ] キャンセル機能が動作するか
- [ ] エラー時の適切な処理
- [ ] 部分的な成功/失敗の扱い

---

## フェーズ4: アラート・品質管理チェックリスト

### 4.1 アラートシステム確認（FR-19, FR-20）

#### AI出力評価
- [ ] 「ほぼ完璧」の自動判定が適切か
- [ ] 「通常再生で確認」の判定基準が適切か
- [ ] 「詳細確認推奨」の判定基準が適切か
- [ ] 「修正必要」の判定基準が適切か
- [ ] 判定結果の手動修正が可能か

#### 危険物検出
- [ ] 水面の検出精度が十分か
- [ ] 鏡面の検出精度が十分か
- [ ] 反射面の検出精度が十分か
- [ ] カスタムルールの追加が可能か
- [ ] 誤検出率が許容範囲内か

### 4.2 品質検証確認

#### 自動検証（NFR-19〜NFR-23）
- [ ] 音声ビットパーフェクト検証（±1 LSB以内）
- [ ] 色差検証（ΔE00 ≤ 1.0）
- [ ] PTS誤差検証（±0.5ms以内）
- [ ] フィールドオーダー維持確認
- [ ] 自動検証スクリプトが正しく動作するか

#### レポート生成
- [ ] JSON形式でのレポート出力
- [ ] HTML形式での見やすいレポート
- [ ] エラー箇所の特定が容易か
- [ ] 統計情報が含まれているか

### 4.3 学習データ収集確認（FR-22〜FR-25）

#### サンプリング
- [ ] 削除マスクが誤検出として記録されるか
- [ ] 追加マスクが検出漏れとして記録されるか
- [ ] ユーザー同意なしでデータ収集されないか
- [ ] プライバシー保護が適切か

#### エクスポート
- [ ] COCO形式での出力が正しいか
- [ ] YOLO形式での出力が正しいか
- [ ] メタデータが適切に含まれているか
- [ ] 差分データのみの出力が可能か

---

## フェーズ5: パフォーマンス最適化チェックリスト

### 5.1 マルチビュー確認（FR-9）

#### 表示機能
- [ ] 3ペイン同時表示が可能か
- [ ] 各ビューの同期が正確か
- [ ] レイアウトのカスタマイズが可能か
- [ ] 個別ビューの最大化が可能か

#### パフォーマンス
- [ ] 3ビュー同時でも滑らかな再生か
- [ ] メモリ使用量が3倍以内か
- [ ] GPU使用率が適切か

### 5.2 高度な再生機能確認（FR-7）

#### 再生速度
- [ ] 0.1x〜10xの速度調整が可能か
- [ ] 逆再生が可能か
- [ ] フレーム単位のコマ送りが可能か
- [ ] 音声同期が維持されるか（通常速度時）

#### 再生モード
- [ ] 確認用モード（高品質）が機能するか
- [ ] 閲覧用モード（高速）が機能するか
- [ ] モード切り替えが即座に反映されるか

### 5.3 キーフレーム機能確認（FR-16）

#### エディタ機能
- [ ] キーフレームの追加/削除が可能か
- [ ] 補間曲線の編集が可能か
- [ ] ベジェ曲線での補間が可能か
- [ ] リニア補間が可能か

#### アニメーション
- [ ] エフェクト強度の時間変化が滑らかか
- [ ] 複数パラメータの同時アニメーションが可能か
- [ ] プレビューが正確か

---

## フェーズ6: 最終仕上げチェックリスト

### 6.1 非破壊レンダリング確認（FR-26）

#### レンダリング品質
- [ ] 元動画が変更されずに保持されるか
- [ ] 低解像度プレビューが高速に生成されるか
- [ ] 高解像度出力の品質が十分か
- [ ] バッチレンダリングが安定動作するか

#### 出力設定
- [ ] 主要コーデックが選択可能か（FR-40）
- [ ] ビットレート設定が可能か
- [ ] 品質プリセットが用意されているか
- [ ] メタデータの編集が可能か

### 6.2 プラグインシステム確認（FR-27）

#### API機能
- [ ] Python APIが文書化されているか
- [ ] サンプルプラグインが提供されているか
- [ ] エフェクトプラグインが作成可能か
- [ ] 入出力プラグインが作成可能か

#### 管理機能
- [ ] プラグインの有効/無効が可能か
- [ ] バージョン管理が機能するか
- [ ] 依存関係のチェックが行われるか
- [ ] エラー時の適切な処理

### 6.3 国際化対応確認（NFR-16）

#### 言語切り替え
- [ ] 日本語がデフォルトで表示されるか
- [ ] 英語への切り替えが可能か
- [ ] 中国語への切り替えが可能か
- [ ] 言語切り替えが即座に反映されるか

#### 翻訳品質
- [ ] UIテキストが適切に翻訳されているか
- [ ] エラーメッセージが翻訳されているか
- [ ] ヘルプドキュメントが翻訳されているか
- [ ] 文字化けや表示崩れがないか

---

## パフォーマンステストチェックリスト

### 基準値確認
- [ ] 1080p@30fps: ≤50ms/frame（NFR-1）
- [ ] 4K@30fps: 設計上対応可能（NFR-3）
- [ ] メモリ使用量: 8GB RAM環境で動作
- [ ] GPU使用率: 効率的な使用

### ストレステスト
- [ ] 1時間以上の動画で安定動作
- [ ] 1000個以上のマスクで動作
- [ ] 24時間連続稼働で安定
- [ ] メモリリークがない

### 互換性テスト（NFR-13）
- [ ] Windows 10以降で動作
- [ ] macOS 12以降で動作
- [ ] Ubuntu 22.04以降で動作
- [ ] 各OSでのUI表示が正常

---

## セキュリティ/プライバシーチェックリスト（NFR-10, NFR-11）

### データ保護
- [ ] ローカル処理がデフォルト
- [ ] サーバー接続は明示的許可のみ
- [ ] 無断でのデータ送信なし
- [ ] ログにセンシティブ情報なし

### 通信セキュリティ
- [ ] クラウド送信時のAES-256暗号化
- [ ] 期限付き署名URLの使用
- [ ] SSL/TLS通信の実装
- [ ] 認証トークンの適切な管理

---

## 最終確認チェックリスト

### ドキュメント
- [ ] ユーザーマニュアルの完成
- [ ] API仕様書の完成
- [ ] インストールガイドの完成
- [ ] トラブルシューティングガイド

### 品質保証
- [ ] 全機能要件（FR）の実装確認
- [ ] 全非機能要件（NFR）の達成確認
- [ ] 受入れ基準の全項目クリア
- [ ] ユーザビリティテストの実施

### リリース準備
- [ ] バージョン番号の設定
- [ ] リリースノートの作成
- [ ] インストーラーの作成
- [ ] 配布方法の確立