# Mask Editor GOD アーキテクチャ図

## 全体アーキテクチャ（Hexagonal Architecture）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            Application Layer                             │
│                               (main.py)                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            Primary Adapters                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │
│  │  Qt UI Adapter  │  │  CLI Adapter    │  │  API Adapter    │        │
│  │  (PyQt6 GUI)    │  │  (Command Line) │  │  (REST/gRPC)    │        │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘        │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Domain Layer (Core)                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        Primary Ports                              │   │
│  │  IApplicationController, IVideoViewer, IMaskEditor               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Business Logic & Services                     │   │
│  │  ProjectService, MaskEditingService, EffectService, etc.         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        Secondary Ports                            │   │
│  │  IVideoReader, IVideoWriter, IMaskProcessor, IProjectRepository  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Secondary Adapters                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌───────────┐  │
│  │ PyAV Adapter │  │OpenCV Adapter│  │ JSON Adapter │  │C++ Adapter│  │
│  │(Video I/O)   │  │(Mask Process)│  │(Project Save)│  │(Fast Proc)│  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └───────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         External Systems                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌───────────┐  │
│  │    FFmpeg    │  │   OpenCV     │  │ File System  │  │    GPU    │  │
│  │              │  │              │  │              │  │   (CUDA)  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └───────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## データフロー図

```
┌─────────────┐     FrameDTO      ┌─────────────┐     MaskDTO      ┌─────────────┐
│   Video     │ ────────────────> │   Domain    │ ────────────────> │    Mask     │
│   Reader    │                   │   Logic     │                   │  Processor  │
└─────────────┘                   └─────────────┘                   └─────────────┘
      ▲                                  │                                  │
      │                                  │                                  │
      │                                  ▼                                  ▼
┌─────────────┐                   ┌─────────────┐                   ┌─────────────┐
│  Video File │                   │   Effect    │                   │ Mask File   │
│  (MP4/MOV)  │                   │   Engine    │                   │ (NPY/PNG)   │
└─────────────┘                   └─────────────┘                   └─────────────┘
```

## DIコンテナによる依存関係解決

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            DI Container                                  │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        Service Registry                           │   │
│  │                                                                   │   │
│  │  IVideoReader ─────> PyAVVideoReaderAdapter     (transient)     │   │
│  │  IVideoWriter ─────> PyAVVideoWriterAdapter     (transient)     │   │
│  │  IMaskProcessor ───> OpenCVMaskProcessorAdapter (transient)     │   │
│  │  IProjectRepository > JsonProjectRepositoryAdapter (singleton)   │   │
│  │                                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      Configuration Store                          │   │
│  │                                                                   │   │
│  │  components.video_reader.backend = "pyav" | "cpp"               │   │
│  │  components.mask_processor.backend = "opencv" | "cpp"           │   │
│  │  performance.gpu_enabled = true                                 │   │
│  │  performance.thread_count = 4                                   │   │
│  │                                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

## DTO/VO 階層

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Data Transfer Objects (DTO)                      │
│  ┌────────────┐  ┌────────────┐  ┌─────────────────┐  ┌────────────┐  │
│  │ FrameDTO   │  │  MaskDTO   │  │VideoMetadataDTO │  │  AlertDTO  │  │
│  │           │  │            │  │                 │  │            │  │
│  │ - RGB24    │  │ - uint8    │  │ - width/height  │  │ - level    │  │
│  │ - numpy    │  │ - numpy    │  │ - fps/duration  │  │ - type     │  │
│  └────────────┘  └────────────┘  └─────────────────┘  └────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Value Objects (VO)                              │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌─────────────────┐  │
│  │  Timecode  │  │ ColorSpace │  │ Resolution │  │   FrameRate     │  │
│  │            │  │            │  │            │  │                 │  │
│  │ - SMPTE    │  │ - BT.709   │  │ - 1920x1080│  │ - 29.97fps      │  │
│  │ - DF/NDF   │  │ - HDR/SDR  │  │ - 4K/8K    │  │ - exact fraction│  │
│  └────────────┘  └────────────┘  └────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## C++統合アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Python Application                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Python Port (Protocol)                        │   │
│  │  class IVideoReader(Protocol):                                   │   │
│  │      def read_frame(self, index: int) -> FrameDTO: ...          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              ▲                    ▲                      │
│                              │                    │                      │
│  ┌───────────────────────────┴──────┐  ┌────────┴──────────────────┐   │
│  │   PyAVVideoReaderAdapter         │  │  CppVideoReaderAdapter    │   │
│  │   (Pure Python Implementation)   │  │  (pybind11 wrapper)      │   │
│  └──────────────────────────────────┘  └───────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                                    │
                                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           C++ Implementation                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  class CppVideoReader {                                          │   │
│  │  public:                                                         │   │
│  │      py::dict read_frame(int index);  // Returns DTO as dict   │   │
│  │  private:                                                        │   │
│  │      AVFormatContext* format_ctx_;    // Direct FFmpeg         │   │
│  │  };                                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

## コンポーネント置換の流れ

```
1. 設定ファイルの変更
   config.yaml:
   components:
     video_reader:
       backend: "pyav" → "cpp"

2. アプリケーション起動時
   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
   │ Config File  │ ──> │ DI Container │ ──> │   Factory    │
   └──────────────┘     └──────────────┘     └──────────────┘
                               │                      │
                               ▼                      ▼
                        Register Services      Create Instance
                        IVideoReader →         CppVideoReader
                        CppVideoReaderAdapter

3. 実行時
   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
   │  UI Layer    │ ──> │   Service    │ ──> │ C++ Adapter  │
   │              │     │              │     │              │
   │ resolve()    │     │ IVideoReader │     │ High Speed!  │
   └──────────────┘     └──────────────┘     └──────────────┘
```

